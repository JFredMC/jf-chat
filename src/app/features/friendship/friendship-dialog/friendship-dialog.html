<div 
  class="fixed inset-0 bg-black/60 backdrop-blur-sm z-50 flex items-center justify-center p-4"
  (click)="closed.emit()"
>
  <!-- Diálogo -->
  <div 
    class="bg-white dark:bg-gray-800 rounded-2xl shadow-2xl w-full max-w-md max-h-[85vh] flex flex-col border border-gray-200 dark:border-gray-700"
    (click)="stopPropagation($event)"
  >
    <!-- Header -->
    <div class="flex items-center justify-between p-6 pb-4">
      <div class="flex items-center space-x-3">
        <div class="w-10 h-10 rounded-xl bg-gradient-to-br from-blue-500 to-purple-600 flex items-center justify-center text-white font-bold">
          <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M18 9v3m0 0v3m0-3h3m-3 0h-3m-2-5a4 4 0 11-8 0 4 4 0 018 0zM3 20a6 6 0 0112 0v1H3v-1z"/>
          </svg>
        </div>
        <div>
          <h2 class="text-xl font-bold text-gray-900 dark:text-white" i18n>Seleccionar Contacto</h2>
          <p class="text-sm text-gray-500 dark:text-gray-400" i18n>Elige un contacto para chatear</p>
        </div>
      </div>
      <button
        class="p-2 rounded-lg text-gray-400 hover:text-gray-600 dark:hover:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700 transition-all duration-200"
        (click)="closed.emit()"
        aria-label="Cerrar"
      >
        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
        </svg>
      </button>
    </div>

    <!-- Barra de búsqueda -->
    <div class="px-6 pb-4">
      <div class="relative">
        <svg class="absolute left-3 top-1/2 transform -translate-y-1/2 w-5 h-5 text-gray-400" 
             fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" 
                d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"/>
        </svg>
        <input
          type="text"
          placeholder="Buscar contactos..."
          class="w-full pl-11 pr-4 py-3 bg-gray-50 dark:bg-gray-700/50 border border-gray-200 dark:border-gray-600 rounded-xl text-gray-900 dark:text-white placeholder-gray-500 dark:placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all duration-200"
          (input)="onSearchChange($event)"
          [value]="searchQuery()"
        >
      </div>
    </div>

    <!-- Lista de contactos -->
    <div class="flex-1 overflow-y-auto px-3 pb-3">
      @if (isLoading()) {
        <!-- Estado de carga -->
        <div class="flex flex-col items-center justify-center py-12">
          <div class="w-10 h-10 border-4 border-blue-500 border-t-transparent rounded-full animate-spin mb-4"></div>
          <p class="text-gray-500 dark:text-gray-400" i18n>Cargando contactos...</p>
        </div>
      } @else if (filteredContacts().length === 0) {
        <!-- Estado vacío -->
        <div class="flex flex-col items-center justify-center py-12 text-center px-6">
          <div class="w-20 h-20 rounded-2xl bg-gradient-to-br from-gray-100 to-gray-200 dark:from-gray-700 dark:to-gray-600 flex items-center justify-center mb-4">
            <svg class="w-10 h-10 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" 
                    d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197m13.5-9a2.5 2.5 0 11-5 0 2.5 2.5 0 015 0z"/>
            </svg>
          </div>
          <h3 class="text-lg font-semibold text-gray-900 dark:text-white mb-2" i18n>No se encontraron contactos</h3>
          <p class="text-gray-500 dark:text-gray-400 text-sm" i18n>
            {{ searchQuery() ? 'Prueba con otros términos de búsqueda' : 'Añade contactos para comenzar a chatear' }}
          </p>
        </div>
      } @else {
        <!-- Lista de contactos -->
        <div class="space-y-2">
          @for (friendship of filteredContacts(); track friendship.id) {
            @let displayName = getContactDisplayName(friendship.friend);
            <button
              class="w-full flex items-center space-x-4 p-4 rounded-xl transition-all duration-200 group border border-transparent hover:border-gray-200 dark:hover:border-gray-600 hover:bg-gray-50 dark:hover:bg-gray-700/50"
              [class.bg-blue-50]="isSelected(friendship.friend)"
              [class.border-blue-200]="isSelected(friendship.friend)"
              [class.dark:bg-blue-900/20]="isSelected(friendship.friend)"
              [class.dark:border-blue-800]="isSelected(friendship.friend)"
              (click)="selectContact(friendship.friend)"
            >
              <!-- Avatar -->
              <div class="relative flex-shrink-0">
                <div 
                  class="w-14 h-14 rounded-2xl flex items-center justify-center text-white font-semibold text-lg shadow-lg"
                  [class]="friendship.friend.avatar_url ? '' : getContactAvatarColor(friendship.friend)"
                >
                  @if (friendship.friend.avatar_url) {
                    <img 
                      [src]="friendship.friend.avatar_url" 
                      [alt]="displayName"
                      class="w-14 h-14 rounded-2xl object-cover"
                    >
                  } @else {
                    {{ getContactInitials(friendship.friend) }}
                  }
                </div>
                <!-- Indicador de estado en línea -->
                @if (isContactOnline(friendship.friend)) {
                  <div class="absolute bottom-0 right-0 w-4 h-4 bg-green-500 rounded-full border-2 border-white dark:border-gray-800 shadow-sm"></div>
                } @else {
                  <div class="absolute bottom-0 right-0 w-4 h-4 bg-gray-300 dark:bg-gray-600 rounded-full border-2 border-white dark:border-gray-800 shadow-sm"></div>
                }
              </div>

              <!-- Información del contacto -->
              <div class="flex-1 text-left min-w-0">
                <div class="flex items-center justify-between mb-1">
                  <p class="font-semibold text-gray-900 dark:text-white truncate group-hover:text-blue-600 dark:group-hover:text-blue-400 transition-colors">
                    {{ displayName }}
                  </p>
                  @if (!isContactOnline(friendship.friend)) {
                    @let lastSeen = getLastSeen(friendship.friend);
                    @if (lastSeen) {
                      <span class="text-xs text-gray-400 dark:text-gray-500 flex-shrink-0 ml-2">
                        {{ lastSeen }}
                      </span>
                    }
                  }
                </div>
                <p class="text-sm text-gray-500 dark:text-gray-400 truncate">@{{ friendship.friend.username }}</p>
                
                <!-- Estado personalizado -->
                @if (friendship.friend.status && friendship.friend.status !== 'online') {
                  <p class="text-xs text-gray-400 dark:text-gray-500 mt-1 truncate">{{ friendship.friend.status }}</p>
                }
              </div>

              <!-- Icono de selección -->
              <div 
                class="w-6 h-6 rounded-full border-2 border-gray-300 dark:border-gray-600 flex items-center justify-center transition-all duration-200 flex-shrink-0"
                [class.bg-blue-500]="isSelected(friendship.friend)"
                [class.border-blue-500]="isSelected(friendship.friend)"
              >
                @if (isSelected(friendship.friend)) {
                  <svg class="w-3 h-3 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M5 13l4 4L19 7"/>
                  </svg>
                }
              </div>
            </button>
          }
        </div>
      }
    </div>

    <!-- Footer -->
    <div class="p-6 pt-4 border-t border-gray-100 dark:border-gray-700 bg-gray-50/50 dark:bg-gray-700/30 rounded-b-2xl">
      <div class="flex justify-between items-center">
        <span class="text-sm text-gray-500 dark:text-gray-400" i18n>
          {{ filteredContacts().length }} {{ filteredContacts().length === 1 ? 'contacto' : 'contactos' }}
        </span>
        <div class="flex space-x-3">
          <button
            class="px-6 py-2.5 text-sm font-medium text-gray-700 dark:text-gray-300 hover:text-gray-900 dark:hover:text-white hover:bg-gray-100 dark:hover:bg-gray-600 rounded-lg transition-all duration-200"
            (click)="closed.emit()"
            i18n
          >
            Cancelar
          </button>
          <button
            class="px-6 py-2.5 text-sm font-medium text-white bg-gradient-to-br from-blue-500 to-purple-600 hover:from-blue-600 hover:to-purple-700 rounded-lg shadow-sm transition-all duration-200 disabled:opacity-50 disabled:cursor-not-allowed"
            [disabled]="!selectedFriend()"
            (click)="confirmSelection()"
            i18n
          >
            Iniciar Chat
          </button>
        </div>
      </div>
    </div>
  </div>
</div>